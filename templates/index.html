<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en" data-theme="forest">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crocle</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
</head>

  <body class="min-h-screen">
    <main class="mx-auto">
      <header class="w-full h-32 p-8">
        <p class="font-bold text-2xl">Crocle</p>
      </header>

    <section class="grid gap-8 lg:grid-cols-[minmax(0,1.3fr)_minmax(0,1fr)] px-8">
      <div class="card bg-base-200 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Files</h2>
          <p class="text-sm text-base-content/70">Browse the read-only folder and pick one file to send.</p>
          <div
            id="files"
            class="mt-4 max-h-[60vh] overflow-y-auto pr-1"
            hx-get="/files"
            hx-swap="innerHTML"
            hx-trigger="load"
          >
            <div class="space-y-3">
              <div class="skeleton h-10 w-full"></div>
              <div class="skeleton h-10 w-5/6"></div>
              <div class="skeleton h-10 w-2/3"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="grid gap-8">
        <div class="card bg-base-200 shadow">
          <div class="card-body gap-2">
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-base-content/50">Selection</p>
            <div class="text-sm">
              <span id="selected-file" class="font-semibold text-base-content">No file selected</span>
            </div>
            <button id="send-button" class="btn btn-primary btn-disabled btn-sm" disabled>
              Send
            </button>
          </div>
        </div>
        <div class="card bg-base-200 shadow-lg">
          <div class="card-body">
            <h2 class="card-title">Transfer status</h2>
            <p id="transfer-state" class="text-sm text-base-content/70">Waiting for a file selection.</p>
            <progress
              id="transfer-progress"
              class="progress progress-primary w-full"
              value="0"
              max="100"
            ></progress>
            <div class="mt-2 flex flex-wrap items-center gap-2 text-sm">
              <span class="badge badge-ghost">Code</span>
              <span id="transfer-code" class="font-semibold">—</span>
            </div>
            <div class="mt-3 rounded-xl border border-base-300 bg-base-100 px-3 py-2 text-xs text-base-content/70">
              <span class="font-semibold">Last output:</span>
              <span id="transfer-output">—</span>
            </div>
          </div>
        </div>
        <div class="card bg-base-200 shadow-lg">
          <div class="card-body">
            <h2 class="card-title">Settings</h2>
            <div class="mt-4 grid gap-4">
              <div class="form-control flex flex-row items-center gap-4">
                <span class="label-text">Hashing algorithm</span>
                <div class="join w-full" id="hash-select">
                  <button
                    type="button"
                    class="btn join-item btn-active"
                    data-hash="imohash"
                  >
                    imohash
                  </button>
                  <button type="button" class="btn join-item" data-hash="default">
                    default
                  </button>
                </div>
              </div>
            </div>

            <div class="mt-6 rounded-2xl border border-base-300 bg-base-100 p-4">
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-base-content/50">
                Send command
              </p>
              <p class="mt-2 text-sm text-base-content/70">
                The file will be sent using this command:
              </p>
              <div class="mt-3 mockup-code bg-neutral text-neutral-content">
                <pre data-prefix="$"><code id="command-preview">croc send --hash imohash &lt;filename&gt;</code></pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    </main>

    <script>
      const selectedFile = document.getElementById('selected-file')
      const sendButton = document.getElementById('send-button')
      const hashSelect = document.getElementById('hash-select')
      const commandPreview = document.getElementById('command-preview')
      const transferState = document.getElementById('transfer-state')
      const transferProgress = document.getElementById('transfer-progress')
      const transferCode = document.getElementById('transfer-code')
      const transferOutput = document.getElementById('transfer-output')
      let eventSource = null

      function updateCommand() {
        const fileName = selectedFile.dataset.fileName || '<filename>'
        const active = hashSelect.querySelector('.btn-active')
        const hash = active ? active.dataset.hash : 'imohash'
        const command = `croc send --hash ${hash} ${fileName}`
        commandPreview.textContent = command
      }

      function updateSelection(target) {
        document.querySelectorAll('[data-file-row]').forEach((row) => {
          row.classList.remove('border-primary', 'bg-base-300/50')
        })

        target.classList.add('border-primary', 'bg-base-300/50')
        const fileName = target.dataset.fileName
        selectedFile.textContent = fileName
        selectedFile.dataset.fileName = fileName
        sendButton.removeAttribute('disabled')
        sendButton.classList.remove('btn-disabled')
        updateCommand()
      }

      async function startTransfer() {
        const fileName = selectedFile.dataset.fileName
        if (!fileName) return

        const active = hashSelect.querySelector('.btn-active')
        const hash = active ? active.dataset.hash : 'imohash'

        sendButton.setAttribute('disabled', 'disabled')
        sendButton.classList.add('btn-disabled')
        transferState.textContent = 'Starting transfer...'
        transferProgress.value = 0
        transferCode.textContent = '—'
        transferOutput.textContent = '—'

        const formData = new FormData()
        formData.set('filename', fileName)
        formData.set('hash', hash)

        const response = await fetch('/transfer/start', {
          method: 'POST',
          body: formData,
        })

        const data = await response.json()
        if (!response.ok) {
          transferState.textContent = data.error || 'Unable to start transfer.'
          sendButton.removeAttribute('disabled')
          sendButton.classList.remove('btn-disabled')
          return
        }

        if (eventSource) {
          eventSource.close()
        }

        eventSource = new EventSource(`/transfer/${data.id}/stream`)
        eventSource.onmessage = (event) => {
          const payload = JSON.parse(event.data)
          if (payload.status) {
            transferState.textContent = `Status: ${payload.status}`
          }
          if (payload.progress !== undefined && payload.progress !== null) {
            transferProgress.value = payload.progress
          }
          if (payload.code) {
            transferCode.textContent = payload.code
          }
          if (payload.line) {
            transferOutput.textContent = payload.line
          }
          if (payload.type === 'complete' || payload.type === 'timeout') {
            sendButton.removeAttribute('disabled')
            sendButton.classList.remove('btn-disabled')
            eventSource.close()
          }
        }
        eventSource.onerror = () => {
          transferState.textContent = 'Connection lost.'
          sendButton.removeAttribute('disabled')
          sendButton.classList.remove('btn-disabled')
          eventSource.close()
        }
      }

      document.addEventListener('click', (event) => {
        const row = event.target.closest('[data-file-row]')
        if (!row) return
        updateSelection(row)
      })

      sendButton.addEventListener('click', startTransfer)

      document.addEventListener('htmx:afterSwap', () => {
        if (window.lucide) {
          window.lucide.createIcons()
        }
      })

      hashSelect.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-hash]')
        if (!button) return
        hashSelect.querySelectorAll('button[data-hash]').forEach((item) => {
          item.classList.remove('btn-active')
        })
        button.classList.add('btn-active')
        updateCommand()
      })

      if (window.lucide) {
        window.lucide.createIcons()
      }

      updateCommand()
    </script>
  </body>

</html>
