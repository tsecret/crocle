<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en" data-theme="forest">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crocle</title>
    <link rel="icon" type="image/png" href="/assets/crocle.png" />
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
</head>

  <body class="min-h-screen">
    <main class="mx-auto w-full max-w-6xl pb-8">
      <header class="w-full p-4 md:p-8">
        <div class="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center sm:gap-6">
          <div class="flex items-center gap-4">
            <img
              src="/assets/crocle.png"
              alt="Crocle"
              class="h-12 w-12 rounded-xl object-cover"
            />
            <p class="font-bold text-2xl">Crocle</p>
          </div>
          <div class="flex flex-wrap items-center gap-2 sm:gap-3">
            <a class="btn btn-ghost btn-sm" href="/acknowledgements">Acknowledgements</a>
            <a
              class="btn btn-outline btn-sm"
              href="https://github.com/tsecret/crocle"
              target="_blank"
              rel="noreferrer"
            >
              GitHub
            </a>
          </div>
        </div>
      </header>

    <section class="grid items-start gap-6 px-2 sm:px-4 md:px-8 lg:grid-cols-[minmax(0,1.3fr)_minmax(0,1fr)]">
      <div class="card min-w-0 bg-base-200 shadow-xl">
        <div class="card-body flex flex-col justify-start">
          <h2 class="card-title">Files</h2>
          <p class="text-sm text-base-content/70">Browse the read-only folder and pick one file to send.</p>
          <div
            id="files"
            class="mt-4 flex min-h-0 max-h-[60vh] flex-col justify-start overflow-y-auto pr-1 sm:max-h-[65vh] lg:max-h-[75vh]"
            hx-get="/files"
            hx-swap="innerHTML"
            hx-trigger="load"
          >
            <div class="space-y-3">
              <div class="skeleton h-10 w-full"></div>
              <div class="skeleton h-10 w-5/6"></div>
              <div class="skeleton h-10 w-2/3"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="grid min-w-0 gap-6">
        <div class="card min-w-0 bg-base-200 shadow-lg">
          <div class="card-body">
            <h2 class="card-title">Send command</h2>
            <p class="text-sm text-base-content/70">
              The file will be sent using this command:
            </p>
            <div class="mt-3 max-w-full overflow-x-auto rounded-xl bg-neutral text-neutral-content px-3 py-2">
              <pre class="m-0 whitespace-pre-wrap break-normal"><code id="command-preview">$ croc send --hash imohash &lt;filename&gt;</code></pre>
            </div>
          </div>
        </div>
        <div class="card min-w-0 bg-base-200 shadow">
          <div class="card-body gap-2">
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-base-content/50">Selection</p>
            <div class="text-sm">
              <span id="selected-file" class="font-semibold text-base-content">No file selected</span>
            </div>
            <p id="selection-status" class="text-xs text-base-content/60">Select a file to start a transfer.</p>
            <button id="send-button" class="btn btn-primary btn-disabled btn-sm" disabled>
              Send
            </button>
          </div>
        </div>
        <div class="card min-w-0 bg-base-200 shadow-lg">
          <div class="card-body">
            <h2 class="card-title">Current transfers</h2>

            <div
              hx-get="/transfers"
              hx-trigger="load, every 5s [document.hasFocus()], every 15s [!document.hasFocus()]"
            ></div>
          </div>
        </div>
      </div>
    </section>
    </main>

    <script>
      const selectedFile = document.getElementById('selected-file')
      const selectionStatus = document.getElementById('selection-status')
      const sendButton = document.getElementById('send-button')
      const commandPreview = document.getElementById('command-preview')
      const currentTransfers = document.getElementById('current-transfers')

      function updateCommand() {
        const fileName = selectedFile.dataset.filePath || '<filename>'
        const command = `$ croc send --hash imohash ${fileName}`
        commandPreview.textContent = command
      }

      function updateSelection(target) {
        document.querySelectorAll('[data-file-row]').forEach((row) => {
          row.classList.remove('border-primary', 'bg-base-300/50')
        })
        document.querySelectorAll('[data-folder-row]').forEach((row) => {
          row.classList.remove('border-primary', 'bg-base-300/50')
        })

        target.classList.add('border-primary', 'bg-base-300/50')
        const fileName = target.dataset.fileName
        const filePath = target.dataset.filePath || fileName
        selectedFile.textContent = fileName
        selectedFile.dataset.filePath = filePath
        sendButton.removeAttribute('disabled')
        sendButton.classList.remove('btn-disabled')
        updateCommand()
      }

      function updateFolderSelection(target) {
        document.querySelectorAll('[data-file-row]').forEach((row) => {
          row.classList.remove('border-primary', 'bg-base-300/50')
        })
        document.querySelectorAll('[data-folder-row]').forEach((row) => {
          row.classList.remove('border-primary', 'bg-base-300/50')
        })

        target.classList.add('border-primary', 'bg-base-300/50')
        const folderPath = target.dataset.folderPath
        selectedFile.textContent = folderPath
        selectedFile.dataset.filePath = folderPath
        sendButton.removeAttribute('disabled')
        sendButton.classList.remove('btn-disabled')
        updateCommand()
      }

      async function startTransfer() {
        const fileName = selectedFile.dataset.filePath
        if (!fileName) return

        const hash = 'imohash'

        sendButton.setAttribute('disabled', 'disabled')
        sendButton.classList.add('btn-disabled')
        selectionStatus.textContent = 'Starting transfer...'

        const formData = new FormData()
        formData.set('filename', fileName)
        formData.set('hash', hash)

        const response = await fetch('/transfer', {
          method: 'POST',
          body: formData,
        })

        const data = await response.json()
        if (!response.ok) {
          selectionStatus.textContent = data.error || 'Unable to start transfer.'
          sendButton.removeAttribute('disabled')
          sendButton.classList.remove('btn-disabled')
          return
        }
        selectionStatus.textContent = 'Transfer started. Monitor status below.'
        sendButton.removeAttribute('disabled')
        sendButton.classList.remove('btn-disabled')
      }

      document.addEventListener('click', (event) => {
        const row = event.target.closest('[data-file-row]')
        if (!row) return
        updateSelection(row)
      })

      document.addEventListener('click', (event) => {
        const row = event.target.closest('[data-folder-row]')
        if (!row) return
        updateFolderSelection(row)
      })

      document.addEventListener('dblclick', (event) => {
        const row = event.target.closest('[data-folder-row]')
        if (!row) return
        const folderPath = row.dataset.folderPath
        if (!folderPath) return
        htmx.ajax('GET', `/files?path=${encodeURIComponent(folderPath)}`, {
          target: '#files',
          swap: 'innerHTML',
        })
      })

      sendButton.addEventListener('click', startTransfer)

      document.addEventListener('htmx:afterSwap', () => {
        if (window.lucide) {
          window.lucide.createIcons()
        }
      })

      if (window.lucide) {
        window.lucide.createIcons()
      }

      updateCommand()
    </script>
  </body>

</html>
